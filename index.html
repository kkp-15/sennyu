<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>忍者潜入🏯 — ステージ制</title>
<style>
  :root{
    --bg:#0a0f1c; --text:#eef3ff; --muted:#a8b7d3;
    --cell:52px;
    --covered1:#1a2b52; --covered2:#132447; --covered-border:#3a5a94;
    --open1:#0f1b37; --open2:#0a1430; --open-border:#2c497b;
    --frontier:#46e1ff; --frontier-glow:#46e1ff55;
    --locked-stripe:#ffffff15;
    --start-outline:#8bd3ff; --trap-bg:#7a2a2a; --trap-border:#b33a3a;
    --castle-glow:#ffd54f; --focus:#00e5ff;
    --ok:#b4ffb4; --ng:#ff9b9b;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#091327,#0a0f1c); color:var(--text);
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    display:flex; flex-direction:column; align-items:center;
  }
  .wrap{width:100%;max-width:980px;padding:14px 16px}
  header h1{margin:.2em 0 .1em}
  .sub{color:var(--muted);margin:.1rem 0 .6rem}

  .hud{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center;
    background:#0b1630; border:1px solid #263f6a; border-radius:12px; padding:8px 10px; margin-bottom:.5rem;
  }
  .pill{padding:.35em .7em; border-radius:999px; border:1px solid #37568f; background:#0f1b37; font-weight:800}
  .linkbtn{
    appearance:none; border:0; background:transparent; color:#8bd3ff; font-weight:800; cursor:pointer; text-decoration:underline;
  }
  .linkbtn:hover{filter:brightness(1.1)}

  #boardWrap{width:100%;display:flex;justify-content:center;margin:.5rem 0}
  #board{
    display:grid; gap:7px; grid-template-columns:repeat(8,var(--cell));
    background:#0b1734; border:2px solid #233a64; padding:14px; border-radius:16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05),0 16px 40px rgba(0,0,0,.5);
    touch-action:manipulation;
  }
  .cell{
    width:var(--cell); height:var(--cell); border-radius:12px; position:relative;
    display:flex; align-items:center; justify-content:center; user-select:none;
    font-weight:900; font-size:calc(var(--cell)*0.5);
    background:linear-gradient(180deg,var(--covered1),var(--covered2));
    border:2px solid var(--covered-border); color:#e9f1ff; cursor:pointer;
    transition:transform .06s ease, filter .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .cell:hover{filter:brightness(1.07)} .cell:active{transform:translateY(1px)}
  .cell:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

  /* 状態 */
  .cell.open{ background:linear-gradient(180deg,var(--open1),var(--open2)); border-color:var(--open-border); cursor:default; box-shadow:inset 0 3px 10px rgba(0,0,0,.45) }
  .cell.locked{ cursor:not-allowed; opacity:.50; background:repeating-linear-gradient(135deg,var(--locked-stripe) 0 8px,transparent 8px 16px),linear-gradient(180deg,var(--covered1),var(--covered2)) }
  .cell.frontier{ box-shadow:0 0 0 3px var(--frontier) inset, 0 0 16px 2px var(--frontier-glow); border-color:#4bd3ff; filter:brightness(1.06); animation:pulse 1.2s ease-in-out infinite alternate }
  @keyframes pulse{ 0%{ box-shadow:0 0 0 2px var(--frontier) inset, 0 0 10px 1px var(--frontier-glow) } 100%{ box-shadow:0 0 0 4px var(--frontier) inset, 0 0 20px 3px var(--frontier-glow) } }
  .cell.start{ outline:2px dashed var(--start-outline); outline-offset:-2px }
  .cell.castle::after{ content:"🏯"; position:absolute; font-size:calc(var(--cell)*0.62); filter:drop-shadow(0 0 6px rgba(255,213,79,.35)) }
  .cell.trap{ background:linear-gradient(180deg,var(--trap-bg),#4f1111); border-color:var(--trap-border) }
  .safe0{ color:#c6d6f5; opacity:.95 }
  .n1{color:#76b7ff}.n2{color:#55d68c}.n3{color:#ffc14d}.n4{color:#c5a3ff}
  .n5{color:#ff9a6b}.n6{color:#8fe3ff}.n7{color:#ff7d92}.n8{color:#ffffff}

  /* 忍者マーカー */
  .cell.ninja::before{
    content:"🥷"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:calc(var(--cell)*0.58); transform:translateY(-1px);
    filter:drop-shadow(0 0 6px rgba(0,0,0,.45)); animation:ninjaPop .18s ease-out; pointer-events:none;
  }
  @keyframes ninjaPop{ from{ transform:scale(.7) translateY(-1px); opacity:0 } to{ transform:scale(1) translateY(-1px); opacity:1 } }

  /* メッセージ／ボタン */
  .bar{display:flex;gap:12px;justify-content:center;align-items:center;margin:.35rem 0;flex-wrap:wrap}
  .btn{ background:#16264a;border:2px solid #2a4272;color:#eaf1ff;border-radius:14px;font-weight:900;cursor:pointer; box-shadow:0 3px 10px rgba(0,0,0,.35); transition:transform .06s ease,filter .12s ease }
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn-lg{ font-size:1.2rem; padding:16px 26px; width:min(560px,92vw); }
  #message{min-height:1.8em;text-align:center;font-weight:900}
  #message.win{color:var(--ok)} #message.lose{color:var(--ng)}

  /* 成否演出 */
  .shake{ animation:shake .5s ease both 0s 1 }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-6px)} 80%{transform:translateX(4px)} }
  .flash{ position:fixed; inset:0; background:rgba(255,0,0,.16); pointer-events:none; animation:flashOut .5s ease both }
  @keyframes flashOut{ from{opacity:.9} to{opacity:0} }

  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,.7)); z-index:10 }
  .overlay .panel{ background:#0f1b37; border:2px solid #2a4272; border-radius:18px; padding:24px; text-align:center; width:min(640px,92vw); box-shadow:0 20px 60px rgba(0,0,0,.6) }
  .overlay h2{ margin:.2em 0 .2em; font-size:2rem }
  .hidden{ display:none }
  .confetti{ position:fixed; left:0; top:-10vh; width:100%; height:110vh; pointer-events:none; z-index:11; overflow:visible }
  .confetti span{ position:absolute; font-size:28px; animation:fall linear forwards; opacity:.95; }
  @keyframes fall{ 0%{ transform:translateY(-10vh) rotate(0deg) } 100%{ transform:translateY(110vh) rotate(360deg) } }

  @media (max-width:420px){ :root{--cell:48px} .btn-lg{font-size:1.1rem} }
</style>
</head>
<body>
  <header class="wrap">
    <h1>忍者潜入🏯</h1>
    <div class="hud" aria-label="説明と進行状況">
      <span class="pill" id="stagePill">Stage 1</span>
      <span class="pill" id="trapPill">罠: 10</span>
      <span class="pill">数字＝そのマスの <b>周囲8方向</b> にある罠の数</span>
      <button class="linkbtn" id="resetProgress">はじめから</button>
    </div>
    <p class="sub">ルール：左端から<strong>順番に</strong>／上下OK・斜めNG／0でも自動連鎖なし。タップ位置に🥷表示。</p>
  </header>

  <main class="wrap">
    <div id="boardWrap">
      <div id="board" role="grid" aria-label="ゲーム盤面 8×8"></div>
    </div>

    <div class="bar">
      <button id="retry" class="btn btn-lg">🔁 もう一度 挑戦する</button>
    </div>

    <p id="message" aria-live="polite"></p>
  </main>

  <!-- 成否オーバーレイ -->
  <div id="overlay" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="panel">
      <h2 id="ovTitle">🎉 潜入成功！</h2>
      <p id="ovDesc">本丸に到達しました。</p>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button id="ovNext" class="btn btn-lg">⤴ 次のステージへ</button>
        <button id="ovRetry" class="btn btn-lg">🔁 同じステージをやり直す</button>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti hidden"></div>

<script>
/* ===== 8×8 / 左から順のみ / 連鎖なし / 上下OK・斜めNG / ステージ制 ===== */
const SIZE = 8;
const BASE_TRAPS = 10;     // 基準の罠数（Stage 1）
const TRAP_STEP  = 2;      // ステージ毎に増える数
const TRAP_CAP   = 24;     // 上限（行き詰まり防止のため適度に制限）

let level = Number(localStorage.getItem('sennyu_level') || 1);
let board = [];     // 'T' or 0..8
let revealed = [];  // boolean
let trapsThisStage = BASE_TRAPS;
const castle = {x: SIZE-1, y: Math.floor(SIZE/2)};
let ninjaPos = null;

const stagePill = document.getElementById('stagePill');
const trapPill  = document.getElementById('trapPill');

function calcTraps(lv){
  return Math.min(TRAP_CAP, BASE_TRAPS + (lv-1)*TRAP_STEP);
}

function init(){
  trapsThisStage = calcTraps(level);
  stagePill.textContent = `Stage ${level}`;
  trapPill.textContent  = `罠: ${trapsThisStage}`;

  board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  revealed = Array.from({length:SIZE},()=>Array(SIZE).fill(false));
  ninjaPos = null;

  // 罠配置（城・左端除外）
  let placed=0;
  while(placed<trapsThisStage){
    const x=Math.floor(Math.random()*SIZE);
    const y=Math.floor(Math.random()*SIZE);
    if(x===0) continue;
    if(x===castle.x && y===castle.y) continue;
    if(board[y][x]==='T') continue;
    board[y][x]='T'; placed++;
  }

  // 数字（8方向）
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      if(board[y][x]==='T') continue;
      board[y][x] = count8(x,y);
    }
  }

  hideOverlay();
  setMsg("");
  draw();
}

function count8(x,y){
  let c=0;
  for(let dy=-1;dy<=1;dy++){
    for(let dx=-1;dx<=1;dx++){
      if(dx===0&&dy===0) continue;
      const nx=x+dx, ny=y+dy;
      if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) continue;
      if(board[ny][nx]==='T') c++;
    }
  }
  return c;
}

/* 左から順：左端OK、同列上下OK、左隣OK（斜め不可） */
function canOpen(x,y){
  if(revealed[y][x]) return false;
  if(x===0) return true;
  if(y>0 && revealed[y-1][x]) return true;
  if(y<SIZE-1 && revealed[y+1][x]) return true;
  if(x>0 && revealed[y][x-1]) return true;
  return false;
}

function draw(){
  const root=document.getElementById('board');
  root.innerHTML='';
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      const el=document.createElement('button');
      el.type='button'; el.className='cell'; el.setAttribute('role','gridcell');
      el.setAttribute('aria-label',`行${y+1} 列${x+1}`);

      const allowed = canOpen(x,y);

      if(x===0) el.classList.add('start');
      if(x===castle.x && y===castle.y) el.classList.add('castle');

      if(!revealed[y][x]){
        if(allowed) el.classList.add('frontier');
        else el.classList.add('locked');
      }else{
        el.classList.add('open');
        if(board[y][x]==='T'){ el.classList.add('trap'); el.textContent='💥'; }
        else{
          const n=board[y][x];
          if(n===0) el.classList.add('safe0');
          else { el.textContent=n; el.classList.add('n'+n); }
        }
      }

      if (ninjaPos && ninjaPos.x===x && ninjaPos.y===y) el.classList.add('ninja');

      el.addEventListener('click', ()=>onOpen(x,y));
      el.addEventListener('keydown', e=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onOpen(x,y); }
      });

      root.appendChild(el);
    }
  }
}

function onOpen(x,y){
  if(!canOpen(x,y)){ setMsg('左端→到達済みの上下左右だけ開けられます。'); return; }
  if(revealed[y][x]) return;

  revealed[y][x]=true;
  ninjaPos = {x,y};

  if(board[y][x]==='T'){
    setMsg('💥 罠にかかった！', true);
    explodeFX();
    revealAll(); draw();
    // 失敗：レベル維持（同ステージやり直し）
    return;
  }

  draw();

  if(x===castle.x && y===castle.y){
    setMsg('🎉 潜入成功！', false, true);
    celebrateFX();
    revealAll(); draw();
    // クリア：次のステージへ
    level++;
    localStorage.setItem('sennyu_level', String(level));
  }
}

function revealAll(){ for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++) revealed[y][x]=true; }
function setMsg(t, lose=false, win=false){
  const el=document.getElementById('message');
  el.className=''; if(lose) el.classList.add('lose'); if(win) el.classList.add('win');
  el.textContent=t;
}

/* エフェクト */
function explodeFX(){
  document.getElementById('boardWrap').classList.add('shake');
  setTimeout(()=>document.getElementById('boardWrap').classList.remove('shake'),600);
  const flash=document.createElement('div'); flash.className='flash';
  document.body.appendChild(flash); setTimeout(()=>flash.remove(),520);
  // 失敗オーバーレイ
  document.getElementById('ovTitle').textContent='💥 任務失敗…';
  document.getElementById('ovDesc').textContent='罠にかかった！同じステージをやり直そう。';
  document.getElementById('ovNext').classList.add('hidden'); // 失敗時は「次へ」は隠す
  showOverlay();
}
function celebrateFX(){
  const EMOJIS=['🎉','🎀','✨','💐','🥷','👑'];
  const pieces=46;
  const cf=document.getElementById('confetti'); cf.classList.remove('hidden'); cf.innerHTML='';
  for(let i=0;i<pieces;i++){
    const s=document.createElement('span');
    s.textContent=EMOJIS[i%EMOJIS.length];
    s.style.left=Math.random()*100+'%';
    s.style.animationDuration=(1.8+Math.random()*1.8)+'s';
    s.style.animationDelay=(Math.random()*0.2)+'s';
    cf.appendChild(s);
  }
  setTimeout(()=>{ cf.classList.add('hidden'); cf.innerHTML=''; }, 2600);
  // 勝利オーバーレイ
  document.getElementById('ovTitle').textContent='🎉 潜入成功！';
  document.getElementById('ovDesc').textContent='本丸に到達！次のステージへ進めます。';
  document.getElementById('ovNext').classList.remove('hidden');
  showOverlay();
}

function showOverlay(){ document.getElementById('overlay').classList.remove('hidden'); }
function hideOverlay(){ document.getElementById('overlay').classList.add('hidden'); }

/* ボタン */
document.getElementById('retry').addEventListener('click', ()=>init());               // 同ステージ
document.getElementById('ovRetry').addEventListener('click', ()=>{ hideOverlay(); init(); });
document.getElementById('ovNext').addEventListener('click', ()=>{ hideOverlay(); init(); });
document.getElementById('resetProgress').addEventListener('click', ()=>{
  if(confirm('進行状況をリセットして Stage 1 から始めますか？')){
    level = 1; localStorage.setItem('sennyu_level','1'); init();
  }
});

/* 起動 */
init();
</script>
</body>
</html>
